<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>スプリント骨格コーチ（動画入力・一時停止対応）</title>
  <style>
    :root { --w: 480px; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:#0c0f14; color:#e9eef6; }
    header { text-align:center; padding:10px 12px; }
    .wrap { max-width: var(--w); margin: 0 auto; padding: 8px 12px 24px; }
    #stage { position:relative; width:100%; aspect-ratio:9/16; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    #video, #canvas { position:absolute; inset:0; width:100%; height:100%; }
    #video { object-fit: cover; background:#000; }
    #canvas { pointer-events: none; }
    .ctrls { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .ctrls > * { flex: 1 1 180px; }
    .btn, .sel, .chklabel { padding:10px 12px; border-radius:10px; border:1px solid #2a3442; background:#131a22; color:#e9eef6; font-size:14px; }
    .btn { cursor:pointer; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px; }
    .panel { background:#0f141b; border:1px solid #223042; border-radius:10px; padding:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .kpi { display:flex; gap:14px; font-weight:700; }
    .muted { opacity:.7; }
    #log { font-size:12px; background:#0b1220; border:1px solid #203047; padding:8px; border-radius:8px; max-height:170px; overflow:auto; }
    @media (max-width:520px){ :root { --w: 94vw; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
  <header><h1>スプリント骨格コーチ（動画入力・一時停止対応）</h1></header>
  <div class="wrap">
    <div class="ctrls">
      <input id="file" class="btn" type="file" accept="video/*">
      <select id="selModel" class="sel">
        <option value="SINGLEPOSE_LIGHTNING">MoveNet Lightning（高速）</option>
        <option value="SINGLEPOSE_THUNDER">MoveNet Thunder（高精度）</option>
      </select>
      <label class="chklabel"><input type="checkbox" id="showAngles" checked> 角度ラベル表示</label>
    </div>

    <div id="stage">
      <video id="video" controls playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="row">
      <div class="panel">
        <div class="kpi mono">
          <div>左膝: <span id="lknee">–</span>°</div>
          <div>右膝: <span id="rknee">–</span>°</div>
        </div>
        <div class="muted" style="margin-top:6px;">※ 膝角 = 股‐膝‐足首（COCO: 左11-13-15 / 右12-14-16）</div>
      </div>
      <div class="panel mono">
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const fileEl = document.getElementById('file');
    const selModel = document.getElementById('selModel');
    const showAngles = document.getElementById('showAngles');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const lkneeEl = document.getElementById('lknee');
    const rkneeEl = document.getElementById('rknee');
    const logEl = document.getElementById('log');

    let detector = null;
    let running = false;
    let rafId = null;
    let lastModelType = null;

    const log = (m, c) => {
      const p = document.createElement('div');
      if (c) p.style.color = c;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
      logEl.prepend(p);
      console.log(m);
    };

    function resizeCanvasToVideo() {
      const w = video.videoWidth || 720;
      const h = video.videoHeight || 1280;
      canvas.width = w;
      canvas.height = h;
    }

    function angleDeg(ax,ay,bx,by,cx,cy){
      const v1x=ax-bx, v1y=ay-by;
      const v2x=cx-bx, v2y=cy-by;
      const n1=Math.hypot(v1x,v1y), n2=Math.hypot(v2x,v2y);
      if(!n1 || !n2) return NaN;
      let cos=(v1x*v2x+v1y*v2y)/(n1*n2);
      cos=Math.max(-1,Math.min(1,cos));
      return Math.acos(cos)*180/Math.PI;
    }

    function drawLabel(x,y,text){
      ctx.font='16px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
      ctx.textBaseline='top';
      const w = ctx.measureText(text).width + 8;
      ctx.fillStyle='rgba(0,0,0,0.55)';
      ctx.fillRect(x-2,y-2,w,22);
      ctx.fillStyle='#ffffff';
      ctx.fillText(text,x,y);
    }

    function drawPose(kp){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const EDGES={'5,7':1,'7,9':1,'6,8':1,'8,10':1,'5,6':1,'5,11':1,'6,12':1,'11,12':1,'11,13':1,'13,15':1,'12,14':1,'14,16':1};
      const map={}; kp.forEach((p,i)=>map[i]=p);
      Object.keys(EDGES).forEach(e=>{
        const [i,j]=e.split(',').map(Number);
        const a=map[i],b=map[j];
        if(!a||!b||a.score<0.4||b.score<0.4)return;
        ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);
        ctx.lineWidth=3;ctx.strokeStyle='#32de84';ctx.stroke();
      });
      kp.forEach(p=>{
        if(p.score<0.4)return;
        ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);
        ctx.fillStyle='#ffae00';ctx.fill();
      });

      const LH=map[11],LK=map[13],LA=map[15];
      const RH=map[12],RK=map[14],RA=map[16];
      let lk=NaN,rk=NaN;
      if(LH&&LK&&LA&&LH.score>0.4&&LK.score>0.4&&LA.score>0.4){
        lk=angleDeg(LH.x,LH.y,LK.x,LK.y,LA.x,LA.y);
        if(showAngles.checked)drawLabel(LK.x+10,LK.y+10,`L ${lk.toFixed(1)}°`);
      }
      if(RH&&RK&&RA&&RH.score>0.4&&RK.score>0.4&&RA.score>0.4){
        rk=angleDeg(RH.x,RH.y,RK.x,RK.y,RA.x,RA.y);
        if(showAngles.checked)drawLabel(RK.x+10,RK.y+10,`R ${rk.toFixed(1)}°`);
      }
      lkneeEl.textContent=isFinite(lk)?lk.toFixed(1):'–';
      rkneeEl.textContent=isFinite(rk)?rk.toFixed(1):'–';
    }

    async function ensureDetector(){
      const type=selModel.value;
      if(detector&&lastModelType===type)return;
      if(detector)await detector.dispose();
      detector=await poseDetection.createDetector(
        poseDetection.SupportedModels.MoveNet,
        {modelType:poseDetection.movenet.modelType[type]}
      );
      lastModelType=type;
      log(`MoveNetロード: ${type}`,'lime');
    }

    async function loop(){
      if(!running)return;
      rafId=requestAnimationFrame(loop);
      if(video.paused||video.ended||video.readyState<2)return;
      try{
        const poses=await detector.estimatePoses(video);
        if(poses&&poses[0])drawPose(poses[0].keypoints);
      }catch(e){log(`推論エラー:${e.message}`,'tomato');}
    }

    fileEl.addEventListener('change',async(e)=>{
      const f=e.target.files&&e.target.files[0];
      if(!f)return;
      if(video.srcObject)video.srcObject=null;
      video.src=URL.createObjectURL(f);
      video.load();
      await new Promise(res=>video.onloadedmetadata=res);
      resizeCanvasToVideo();
      log(`動画読込: ${f.name}`,'#9ae6b4');
      await ensureDetector();
      running=true;
      log('準備完了：再生ボタンで解析開始','#93c5fd');
    });

    video.addEventListener('play',()=>{
      resizeCanvasToVideo();
      running=true;
      cancelAnimationFrame(rafId);
      loop();
      log('再生開始','#c7f9cc');
    });
    video.addEventListener('pause',()=>{
      cancelAnimationFrame(rafId);
      running=false;
      log('一時停止','#fde68a');
    });
    video.addEventListener('ended',()=>{
      running=false;
      cancelAnimationFrame(rafId);
      log('再生終了','#fca5a5');
    });

    selModel.addEventListener('change',async()=>{
      if(!video.src&&!video.currentSrc)return;
      await ensureDetector();
    });

    log('動画ファイルを選択してください（MP4など）','#a5b4fc');
  </script>
</body>
</html>
