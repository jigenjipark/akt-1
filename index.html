<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>スプリント骨格コーチ BlazePose Lite版（縦横対応・スムーズ再生）</title>
<style>
:root { --w: 720px; }
body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; background:#0c0f14; color:#e9eef6; }
header { text-align:center; padding:10px; }
.wrap { max-width:var(--w); margin:0 auto; padding:10px; }
#stage { position:relative; width:100%; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.35); }
#video { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:0; }
#canvas { position:absolute; inset:0; width:100%; height:100%; }
.ctrls, .kpis { display:grid; gap:10px; margin:12px 0; }
.row { display:flex; gap:8px; flex-wrap:wrap; }
.btn, .sel, .chklabel, input[type=range] {
  border-radius:10px; border:1px solid #2a3442; background:#131a22; color:#e9eef6;
  padding:10px 12px; font-size:14px;
}
.btn { cursor:pointer; }
.mono { font-family:ui-monospace,Menlo,Consolas; }
.panel { background:#0f141b; border:1px solid #223042; border-radius:10px; padding:10px; }
#log { font-size:12px; background:#0b1220; border:1px solid #203047; padding:8px; border-radius:8px; max-height:170px; overflow:auto; }
.timebar { display:flex; align-items:center; gap:10px; }
.timebar input[type=range]{ flex:1 1 auto; height:30px; }
.time { width:95px; text-align:center; }
@media (max-width:760px){ :root { --w:94vw; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10"></script>
</head>
<body>
<header><h1>スプリント骨格コーチ BlazePose Lite版（縦横対応・スムーズ再生）</h1></header>
<div class="wrap">
  <div class="row">
    <input id="file" class="btn" type="file" accept="video/*">
    <label class="chklabel"><input type="checkbox" id="showAngles" checked> 角度ラベル</label>
  </div>

  <div id="stage">
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="ctrls panel">
    <div class="row">
      <button id="btnPlay" class="btn">▶ 再生</button>
      <button id="btnPause" class="btn">⏸ 一時停止</button>
      <button id="btnBack1f" class="btn">◀ 1f</button>
      <button id="btnFwd1f" class="btn">1f ▶</button>
      <button id="btnBack100ms" class="btn">◀ 0.1s</button>
      <button id="btnFwd100ms" class="btn">0.1s ▶</button>
    </div>
    <div class="row">
      <select id="selRate" class="sel">
        <option value="0.25">×0.25</option>
        <option value="0.5">×0.5</option>
        <option value="1" selected>×1.0</option>
        <option value="1.5">×1.5</option>
        <option value="2">×2.0</option>
      </select>
      <label class="chklabel"><input type="checkbox" id="loop"> ループ</label>
    </div>
    <div class="timebar">
      <span class="time mono" id="cur">00:00.00</span>
      <input type="range" id="seek" min="0" max="1000" value="0" step="1">
      <span class="time mono" id="dur">00:00.00</span>
    </div>
  </div>

  <div class="kpis">
    <div class="panel mono" id="angles">
      膝: L<span id="lknee">–</span>° / R<span id="rknee">–</span>°<br>
      肘: L<span id="lelbow">–</span>° / R<span id="relbow">–</span>°<br>
      股関節: L<span id="lhip">–</span>° / R<span id="rhip">–</span>°<br>
      足首(つま先): L<span id="lankle">–</span>° / R<span id="rankle">–</span>°
    </div>
    <div class="panel mono"><div id="log"></div></div>
  </div>
</div>

<script type="module">
import {FilesetResolver, PoseLandmarker} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10";

const video=document.getElementById('video'), canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');
const fileEl=document.getElementById('file'), showAngles=document.getElementById('showAngles');
const selRate=document.getElementById('selRate'), chkLoop=document.getElementById('loop');
const seek=document.getElementById('seek'), cur=document.getElementById('cur'), dur=document.getElementById('dur'), logEl=document.getElementById('log');
const angleEls={lknee:lknee,rknee:rknee,lelbow:lelbow,relbow:relbow,lhip:lhip,rhip:rhip,lankle:lankle,rankle:rankle};
let landmarker=null,running=false,rafId=null,vidW=0,vidH=0,scale=1,offX=0,offY=0;
let lastInferTime=0; // 推論間引き用
const FRAME=1/30,colors={knee:'#32de84',elbow:'#00bfff',hip:'#ba55d3',ankle:'#ffa500'};

function log(m,c){const p=document.createElement('div');if(c)p.style.color=c;p.textContent=`[${new Date().toLocaleTimeString()}] ${m}`;logEl.prepend(p);}
const fmt=s=>!isFinite(s)?'00:00.00':`${String(Math.floor(s/60)).padStart(2,'0')}:${(s%60).toFixed(2).padStart(5,'0')}`;

function resizeCanvas(){
  const stage=document.getElementById('stage');
  if(vidW&&vidH){stage.style.aspectRatio=`${vidW}/${vidH}`;}
  const rect=canvas.getBoundingClientRect();
  canvas.width=Math.round(rect.width);canvas.height=Math.round(rect.height);
  const s=Math.min(canvas.width/vidW,canvas.height/vidH);
  scale=s;offX=(canvas.width-vidW*s)/2;offY=(canvas.height-vidH*s)/2;
}

function angleDeg(ax,ay,bx,by,cx,cy){
  const v1x=ax-bx,v1y=ay-by,v2x=cx-bx,v2y=cy-by;
  const n1=Math.hypot(v1x,v1y),n2=Math.hypot(v2x,v2y);
  if(!n1||!n2)return NaN;
  let cos=(v1x*v2x+v1y*v2y)/(n1*n2);
  return Math.acos(Math.max(-1,Math.min(1,cos)))*180/Math.PI;
}
function drawLabel(x,y,text,color){ctx.font='16px system-ui';ctx.textBaseline='top';const w=ctx.measureText(text).width+8;ctx.fillStyle='rgba(0,0,0,0.55)';ctx.fillRect(x-2,y-2,w,22);ctx.fillStyle=color;ctx.fillText(text,x,y);}

async function init(){
  const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm");
  landmarker=await PoseLandmarker.createFromOptions(vision,{
    baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"},
    runningMode:"VIDEO"
  });
  log("BlazePose Liteモデル読み込み完了","lime");
}
await init();

fileEl.addEventListener('change',async e=>{
  const f=e.target.files[0];if(!f)return;
  video.src=URL.createObjectURL(f);
  await new Promise(r=>video.onloadedmetadata=r);
  vidW=video.videoWidth;vidH=video.videoHeight;resizeCanvas();
  dur.textContent=fmt(video.duration);
  log(`動画読込: ${f.name} (${vidW}×${vidH})`,'#9ae6b4');
  drawFrame();
});
window.addEventListener('resize',resizeCanvas);

function transform(x,y){return [offX+x*scale,offY+y*scale];}

async function drawFrame(){
  if(!landmarker||!video||video.readyState<2)return;
  const now=performance.now();
  if(now-lastInferTime<50)return; // 20fps制限
  lastInferTime=now;
  const res=await landmarker.detectForVideo(video,now);
  if(!res.landmarks||!res.landmarks[0])return;
  const kp=res.landmarks[0];ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,offX,offY,vidW*scale,vidH*scale);
  const map={};for(let i=0;i<kp.length;i++){const[x,y]=transform(kp[i].x*vidW,kp[i].y*vidH);map[i]={x,y};}

  // --- スケルトン描画 ---
  const EDGES=[[11,13],[13,15],[12,14],[14,16],[11,12],[23,24],[23,25],[24,26],[25,27],[26,28],[27,29],[28,30],[27,31],[28,32],[11,23],[12,24]];
  ctx.lineWidth=3;ctx.strokeStyle="#32de84";
  for(const[a,b]of EDGES){const p1=map[a],p2=map[b];if(p1&&p2){ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();}}
  Object.values(map).forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle='#ffae00';ctx.fill();});

  const g=i=>map[i];const L={S:12,E:14,W:16,H:24,K:26,A:28,T:32};const R={S:11,E:13,W:15,H:23,K:25,A:27,T:31};
  const vals={};
  vals.lknee=angleDeg(g(L.H).x,g(L.H).y,g(L.K).x,g(L.K).y,g(L.A).x,g(L.A).y);
  vals.rknee=angleDeg(g(R.H).x,g(R.H).y,g(R.K).x,g(R.K).y,g(R.A).x,g(R.A).y);
  vals.lelbow=angleDeg(g(L.S).x,g(L.S).y,g(L.E).x,g(L.E).y,g(L.W).x,g(L.W).y);
  vals.relbow=angleDeg(g(R.S).x,g(R.S).y,g(R.E).x,g(R.E).y,g(R.W).x,g(R.W).y);
  vals.lhip=angleDeg(g(L.S).x,g(L.S).y,g(L.H).x,g(L.H).y,g(L.K).x,g(L.K).y);
  vals.rhip=angleDeg(g(R.S).x,g(R.S).y,g(R.H).x,g(R.H).y,g(R.K).x,g(R.K).y);
  vals.lankle=angleDeg(g(L.K).x,g(L.K).y,g(L.A).x,g(L.A).y,g(L.T).x,g(L.T).y);
  vals.rankle=angleDeg(g(R.K).x,g(R.K).y,g(R.A).x,g(R.A).y,g(R.T).x,g(R.T).y);

  const c=colors;
  if(showAngles.checked){
    if(isFinite(vals.lknee))drawLabel(g(L.K).x+10,g(L.K).y+10,`L Knee ${vals.lknee.toFixed(1)}°`,c.knee);
    if(isFinite(vals.rknee))drawLabel(g(R.K).x+10,g(R.K).y+10,`R Knee ${vals.rknee.toFixed(1)}°`,c.knee);
    if(isFinite(vals.lelbow))drawLabel(g(L.E).x+10,g(L.E).y+10,`L Elbow ${vals.lelbow.toFixed(1)}°`,c.elbow);
    if(isFinite(vals.relbow))drawLabel(g(R.E).x+10,g(R.E).y+10,`R Elbow ${vals.relbow.toFixed(1)}°`,c.elbow);
    if(isFinite(vals.lhip))drawLabel(g(L.H).x+10,g(L.H).y+10,`L Hip ${vals.lhip.toFixed(1)}°`,c.hip);
    if(isFinite(vals.rhip))drawLabel(g(R.H).x+10,g(R.H).y+10,`R Hip ${vals.rhip.toFixed(1)}°`,c.hip);
    if(isFinite(vals.lankle))drawLabel(g(L.A).x+10,g(L.A).y+10,`L Ankle ${vals.lankle.toFixed(1)}°`,c.ankle);
    if(isFinite(vals.rankle))drawLabel(g(R.A).x+10,g(R.A).y+10,`R Ankle ${vals.rankle.toFixed(1)}°`,c.ankle);
  }
  for(const k in vals){angleEls[k].textContent=isFinite(vals[k])?vals[k].toFixed(1):'–';}
}

async function loop(){
  if(!running)return;
  rafId=requestAnimationFrame(loop);
  if(video.paused||video.ended||video.readyState<2)return;
  drawFrame();
  seek.value=Math.floor((video.currentTime/video.duration)*1000)||0;
  cur.textContent=fmt(video.currentTime);
}

// 再生操作
document.getElementById('btnPlay').onclick=()=>{video.playbackRate=parseFloat(selRate.value);video.loop=chkLoop.checked;video.play();if(!running){running=true;loop();}};
document.getElementById('btnPause').onclick=()=>{video.pause();running=false;cancelAnimationFrame(rafId);drawFrame();};
document.getElementById('btnBack1f').onclick=()=>seekTo(video.currentTime-FRAME);
document.getElementById('btnFwd1f').onclick=()=>seekTo(video.currentTime+FRAME);
document.getElementById('btnBack100ms').onclick=()=>seekTo(video.currentTime-0.1);
document.getElementById('btnFwd100ms').onclick=()=>seekTo(video.currentTime+0.1);
function seekTo(t){video.pause();running=false;video.currentTime=Math.max(0,Math.min(video.duration,t));cur.textContent=fmt(video.currentTime);seek.value=Math.floor((video.currentTime/video.duration)*1000)||0;drawFrame();}
selRate.onchange=()=>video.playbackRate=parseFloat(selRate.value);
chkLoop.onchange=()=>video.loop=chkLoop.checked;
seek.oninput=()=>{if(!video.src||!isFinite(video.duration))return;seekTo((seek.value/1000)*video.duration);};
log('動画を選択 → BlazePose Liteで骨格＋角度解析（縦横対応・20fps制御）','#a5b4fc');
</script>
</body>
</html>
