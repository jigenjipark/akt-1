<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>スプリント骨格コーチ（縦撮り・背面固定）</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background:#0c0f14; color:#e9eef6; }
    header { text-align:center; padding:8px; }
    #stage { position:relative; width:100%; max-width:480px; aspect-ratio:9/16; margin:0 auto; background:#000; }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }
    #canvas { position:absolute; inset:0; width:100%; height:100%; }
    button { margin:8px; padding:12px 20px; font-size:16px; border-radius:8px; border:none; background:#1e293b; color:white; }
    #log { font-size:12px; font-family:monospace; background:#111; padding:8px; max-width:480px; margin:10px auto; border-radius:8px; max-height:200px; overflow:auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
  <header><h1>スプリント骨格コーチ</h1></header>
  <div id="stage">
    <video id="video" autoplay playsinline muted webkit-playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div style="text-align:center;">
    <button id="btnStart">カメラ開始</button>
    <button id="btnRetry">再試行</button>
  </div>
  <div id="log"></div>
  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const logEl=document.getElementById('log');
    let detector=null,stream=null,running=false;

    function log(msg,color){const p=document.createElement('div');if(color)p.style.color=color;p.textContent=msg;logEl.prepend(p);}

    async function initCamera(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({
          audio:false,
          video:{width:{ideal:720},height:{ideal:1280},aspectRatio:{ideal:9/16},facingMode:{exact:'environment'}}
        });
        video.srcObject=stream;await video.play();
        await new Promise(r=>video.onloadedmetadata=r);
        resizeCanvas();log('カメラ起動OK','lime');
      }catch(e){log('カメラ起動失敗:'+e.message,'red');}
    }
    function resizeCanvas(){canvas.width=video.videoWidth||720;canvas.height=video.videoHeight||1280;}
    window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,300));

    async function startDetector(){
      try{
        detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING});
        log('MoveNetロードOK','lime');
      }catch(e){log('MoveNetロード失敗:'+e.message,'red');return;}
      running=true;
      const loop=async()=>{
        if(!running)return;requestAnimationFrame(loop);
        if(video.readyState<2)return;
        const poses=await detector.estimatePoses(video);
        if(poses&&poses[0])drawPose(poses[0].keypoints);
      };
      loop();
    }

    function drawPose(kp){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const map={};kp.forEach((p,i)=>map[i]=p);
      const edges={'5,7':1,'7,9':1,'6,8':1,'8,10':1,'5,6':1,'5,11':1,'6,12':1,'11,12':1,'11,13':1,'13,15':1,'12,14':1,'14,16':1};
      for(const e in edges){const [i,j]=e.split(',').map(Number);const a=map[i],b=map[j];
        if(a&&b&&a.score>0.4&&b.score>0.4){ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.lineWidth=3;ctx.strokeStyle='#00ff99';ctx.stroke();}}
      kp.forEach(p=>{if(p.score>0.4){ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle='#ffae00';ctx.fill();}});
    }

    async function startAll(){await initCamera();await startDetector();}
    document.getElementById('btnStart').onclick=startAll;
    document.getElementById('btnRetry').onclick=()=>{running=false;if(stream)stream.getTracks().forEach(t=>t.stop());startAll();};
  </script>
</body>
</html>