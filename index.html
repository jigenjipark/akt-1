<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>スプリント骨格コーチ（動画入力・カスタムコントローラ）</title>
  <style>
    :root { --w: 520px; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:#0c0f14; color:#e9eef6; }
    header { text-align:center; padding:10px 12px; }
    .wrap { max-width: var(--w); margin: 0 auto; padding: 8px 12px 24px; }
    #stage { position:relative; width:100%; aspect-ratio:9/16; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    #video, #canvas { position:absolute; inset:0; width:100%; height:100%; }
    #video { object-fit: cover; background:#000; }
    #canvas { pointer-events:none; }
    .ctrls, .kpis { display:grid; gap:10px; margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .btn, .sel, .chklabel, input[type=range] {
      border-radius:10px; border:1px solid #2a3442; background:#131a22; color:#e9eef6;
      padding:10px 12px; font-size:14px;
    }
    .btn { cursor:pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .panel { background:#0f141b; border:1px solid #223042; border-radius:10px; padding:10px; }
    #log { font-size:12px; background:#0b1220; border:1px solid #203047; padding:8px; border-radius:8px; max-height:170px; overflow:auto; }
    .timebar { display:flex; align-items:center; gap:10px; }
    .timebar input[type=range]{ flex:1 1 auto; height: 30px; }
    .time { width: 95px; text-align:center; }
    @media (max-width:560px){ :root { --w: 94vw; } }
  </style>
  <!-- TFJS / Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
  <header><h1>スプリント骨格コーチ（動画入力・カスタムコントローラ）</h1></header>
  <div class="wrap">
    <!-- 上部設定 -->
    <div class="row">
      <input id="file" class="btn" type="file" accept="video/*">
      <select id="selModel" class="sel">
        <option value="SINGLEPOSE_LIGHTNING">Lightning（高速）</option>
        <option value="SINGLEPOSE_THUNDER">Thunder（高精度）</option>
      </select>
      <label class="chklabel"><input type="checkbox" id="showAngles" checked> 角度ラベル</label>
    </div>

    <!-- 映像＋オーバーレイ -->
    <div id="stage">
      <!-- ネイティブcontrolsは使わない -->
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <!-- カスタムコントローラ -->
    <div class="ctrls panel">
      <div class="row">
        <button id="btnPlay" class="btn">▶ 再生</button>
        <button id="btnPause" class="btn">⏸ 一時停止</button>
        <button id="btnBack1f" class="btn">◀ 1f</button>
        <button id="btnFwd1f" class="btn">1f ▶</button>
        <button id="btnBack100ms" class="btn">◀ 0.1s</button>
        <button id="btnFwd100ms" class="btn">0.1s ▶</button>
      </div>
      <div class="row">
        <select id="selRate" class="sel">
          <option value="0.25">×0.25</option>
          <option value="0.5">×0.5</option>
          <option value="1" selected>×1.0</option>
          <option value="1.5">×1.5</option>
          <option value="2">×2.0</option>
        </select>
        <label class="chklabel"><input type="checkbox" id="loop"> ループ</label>
      </div>

      <!-- スライダー -->
      <div class="timebar">
        <span class="time mono" id="cur">00:00.00</span>
        <input type="range" id="seek" min="0" max="1000" value="0" step="1">
        <span class="time mono" id="dur">00:00.00</span>
      </div>
    </div>

    <!-- KPI & ログ -->
    <div class="kpis">
      <div class="panel">
        <div class="mono">左膝: <span id="lknee">–</span>°　右膝: <span id="rknee">–</span>°</div>
        <div style="opacity:.7;margin-top:6px;">膝角 = 股‐膝‐足首（COCO: 左11-13-15 / 右12-14-16）</div>
      </div>
      <div class="panel mono"><div id="log"></div></div>
    </div>
  </div>

  <script>
    // DOM
    const fileEl = document.getElementById('file');
    const selModel = document.getElementById('selModel');
    const showAngles = document.getElementById('showAngles');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const lkneeEl = document.getElementById('lknee');
    const rkneeEl = document.getElementById('rknee');
    const logEl = document.getElementById('log');
    const btnPlay = document.getElementById('btnPlay');
    const btnPause = document.getElementById('btnPause');
    const btnBack1f = document.getElementById('btnBack1f');
    const btnFwd1f = document.getElementById('btnFwd1f');
    const btnBack100ms = document.getElementById('btnBack100ms');
    const btnFwd100ms = document.getElementById('btnFwd100ms');
    const selRate = document.getElementById('selRate');
    const chkLoop = document.getElementById('loop');
    const seek = document.getElementById('seek');
    const cur = document.getElementById('cur');
    const dur = document.getElementById('dur');

    // State
    let detector = null;
    let running = false;
    let rafId = null;
    let lastModelType = null;

    const log = (m, c) => {
      const p = document.createElement('div');
      if (c) p.style.color = c;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
      logEl.prepend(p);
      console.log(m);
    };

    // 時間表示
    const fmt = s => {
      if (!isFinite(s)) return '00:00.00';
      const m = Math.floor(s / 60);
      const r = s - m*60;
      return `${String(m).padStart(2,'0')}:${r.toFixed(2).padStart(5,'0')}`;
    };

    function resizeCanvasToVideo() {
      const w = video.videoWidth || 720;
      const h = video.videoHeight || 1280;
      canvas.width = w; canvas.height = h;
    }

    function angleDeg(ax,ay,bx,by,cx,cy){
      const v1x=ax-bx, v1y=ay-by;
      const v2x=cx-bx, v2y=cy-by;
      const n1=Math.hypot(v1x,v1y), n2=Math.hypot(v2x,v2y);
      if(!n1 || !n2) return NaN;
      let cos=(v1x*v2x+v1y*v2y)/(n1*n2);
      cos=Math.max(-1,Math.min(1,cos));
      return Math.acos(cos)*180/Math.PI;
    }

    function drawLabel(x,y,text){
      ctx.font='16px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
      ctx.textBaseline='top';
      const w = ctx.measureText(text).width + 8;
      ctx.fillStyle='rgba(0,0,0,0.55)';
      ctx.fillRect(x-2,y-2,w,22);
      ctx.fillStyle='#ffffff';
      ctx.fillText(text,x,y);
    }

    function drawPose(kp){
      // 背景
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);

      // スケルトン
      const EDGES={'5,7':1,'7,9':1,'6,8':1,'8,10':1,'5,6':1,'5,11':1,'6,12':1,'11,12':1,'11,13':1,'13,15':1,'12,14':1,'14,16':1};
      const map={}; kp.forEach((p,i)=> map[i]=p);

      Object.keys(EDGES).forEach(e=>{
        const [i,j] = e.split(',').map(Number);
        const a=map[i], b=map[j];
        if(!a||!b||a.score<0.4||b.score<0.4) return;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y);
        ctx.lineWidth=3; ctx.strokeStyle='#32de84'; ctx.stroke();
      });
      kp.forEach(p=>{
        if(p.score<0.4) return;
        ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2);
        ctx.fillStyle='#ffae00'; ctx.fill();
      });

      // 膝角度（COCO: L 11-13-15, R 12-14-16）
      const LH=map[11], LK=map[13], LA=map[15];
      const RH=map[12], RK=map[14], RA=map[16];
      let lk=NaN, rk=NaN;
      if(LH&&LK&&LA&&LH.score>0.4&&LK.score>0.4&&LA.score>0.4){
        lk = angleDeg(LH.x,LH.y, LK.x,LK.y, LA.x,LA.y);
        if(showAngles.checked) drawLabel(LK.x+10, LK.y+10, `L ${lk.toFixed(1)}°`);
      }
      if(RH&&RK&&RA&&RH.score>0.4&&RK.score>0.4&&RA.score>0.4){
        rk = angleDeg(RH.x,RH.y, RK.x,RK.y, RA.x,RA.y);
        if(showAngles.checked) drawLabel(RK.x+10, RK.y+10, `R ${rk.toFixed(1)}°`);
      }
      document.getElementById('lknee').textContent = isFinite(lk)? lk.toFixed(1): '–';
      document.getElementById('rknee').textContent = isFinite(rk)? rk.toFixed(1): '–';
    }

    async function ensureDetector(){
      const type = selModel.value;
      if (detector && lastModelType === type) return;
      if (detector) await detector.dispose();
      detector = await poseDetection.createDetector(
        poseDetection.SupportedModels.MoveNet,
        { modelType: poseDetection.movenet.modelType[type] }
      );
      lastModelType = type;
      log(`MoveNetロード: ${type}`, 'lime');
    }

    async function loop(){
      if (!running) return;
      rafId = requestAnimationFrame(loop);
      if (video.paused || video.ended || video.readyState < 2) return;
      try{
        const poses = await detector.estimatePoses(video);
        if (poses && poses[0]) drawPose(poses[0].keypoints);
      }catch(e){
        log(`推論エラー: ${e.message}`, 'tomato');
      }
      // スライダー更新
      seek.value = Math.floor((video.currentTime / video.duration) * 1000) || 0;
      cur.textContent = fmt(video.currentTime);
    }

    // === ファイル選択 ===
    fileEl.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (video.srcObject) video.srcObject = null;
      video.src = URL.createObjectURL(f);
      await new Promise(res => video.onloadedmetadata = res);
      resizeCanvasToVideo();
      dur.textContent = fmt(video.duration);
      cur.textContent = fmt(0);
      seek.value = 0;
      video.loop = chkLoop.checked;
      video.playbackRate = parseFloat(selRate.value);
      log(`動画読込: ${f.name}`, '#9ae6b4');
      await ensureDetector();
      running = false; // 最初は停止状態
      drawStaticFrame(); // 最初のフレームを描画
    });

    function drawStaticFrame(){
      // 静止描画（推論も実施して1枚だけ更新）
      if (video.readyState >= 2){
        detector.estimatePoses(video).then(poses=>{
          if (poses && poses[0]) drawPose(poses[0].keypoints);
        }).catch(()=>{ /* ignore */ });
      }
    }

    // === カスタム操作 ===
    btnPlay.addEventListener('click', ()=>{
      if (!video.src) return;
      video.playbackRate = parseFloat(selRate.value);
      video.loop = chkLoop.checked;
      video.play().then(()=>{
        if (!running){ running = true; cancelAnimationFrame(rafId); loop(); }
      });
    });

    btnPause.addEventListener('click', ()=>{
      video.pause();
      running = false;
      cancelAnimationFrame(rafId);
      drawStaticFrame(); // 止めたフレームを表示維持
    });

    // フレーム長（おおよそ、30fps基準。必要なら推定fpsに変更可）
    const FRAME = 1/30;

    btnBack1f.addEventListener('click', ()=>{
      if (!video.src) return;
      video.pause();
      running = false;
      video.currentTime = Math.max(0, video.currentTime - FRAME);
      cur.textContent = fmt(video.currentTime);
      seek.value = Math.floor((video.currentTime / video.duration) * 1000) || 0;
      drawStaticFrame();
    });
    btnFwd1f.addEventListener('click', ()=>{
      if (!video.src) return;
      video.pause();
      running = false;
      video.currentTime = Math.min(video.duration, video.currentTime + FRAME);
      cur.textContent = fmt(video.currentTime);
      seek.value = Math.floor((video.currentTime / video.duration) * 1000) || 0;
      drawStaticFrame();
    });

    btnBack100ms.addEventListener('click', ()=>{
      if (!video.src) return;
      video.pause();
      running = false;
      video.currentTime = Math.max(0, video.currentTime - 0.1);
      cur.textContent = fmt(video.currentTime);
      seek.value = Math.floor((video.currentTime / video.duration) * 1000) || 0;
      drawStaticFrame();
    });
    btnFwd100ms.addEventListener('click', ()=>{
      if (!video.src) return;
      video.pause();
      running = false;
      video.currentTime = Math.min(video.duration, video.currentTime + 0.1);
      cur.textContent = fmt(video.currentTime);
      seek.value = Math.floor((video.currentTime / video.duration) * 1000) || 0;
      drawStaticFrame();
    });

    // スピード/ループ
    selRate.addEventListener('change', ()=>{ video.playbackRate = parseFloat(selRate.value); });
    chkLoop.addEventListener('change', ()=>{ video.loop = chkLoop.checked; });

    // スライダー
    seek.addEventListener('input', ()=>{
      if (!video.src || !isFinite(video.duration)) return;
      const t = (seek.value / 1000) * video.duration;
      video.currentTime = t;
      cur.textContent = fmt(t);
      drawStaticFrame();
    });

    // モデル切替
    selModel.addEventListener('change', async ()=>{
      if (!video.src && !video.currentSrc) return;
      await ensureDetector();
      drawStaticFrame();
    });

    // 初期メッセージ
    log('動画ファイルを選択 → 再生/一時停止/スライダー/コマ送りが使えます。', '#a5b4fc');
  </script>
</body>
</html>
