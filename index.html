<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>スプリント骨格コーチ BlazePose版（足首角度対応）</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#0c0f14;color:#e9eef6}
    header{text-align:center;padding:10px}
    .wrap{max-width:720px;margin:0 auto;padding:10px}
    #stage{position:relative;width:100%;aspect-ratio:9/16;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
    #video{opacity:0}
    .panel{background:#0f141b;border:1px solid #223042;border-radius:10px;padding:10px;margin-top:10px}
    .btn{border-radius:8px;padding:8px 12px;background:#131a22;color:#e9eef6;border:1px solid #2a3442;cursor:pointer}
    .mono{font-family:ui-monospace,Menlo,Consolas}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10"></script>
</head>
<body>
<header><h1>スプリント骨格コーチ BlazePose版（足首角度対応）</h1></header>
<div class="wrap">
  <input type="file" id="file" class="btn" accept="video/*">
  <label><input type="checkbox" id="showAngles" checked>角度ラベル</label>
  <div id="stage">
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div class="panel mono" id="angles"></div>
  <div class="panel mono" id="log"></div>
</div>

<script type="module">
import {FilesetResolver, PoseLandmarker} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10";

const fileEl=document.getElementById("file");
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const showAngles=document.getElementById("showAngles");
const logEl=document.getElementById("log"),angEl=document.getElementById("angles");

let landmarker=null,playing=false;

function log(msg,color){const p=document.createElement("div");if(color)p.style.color=color;p.textContent=msg;logEl.prepend(p);}
function angleDeg(ax,ay,bx,by,cx,cy){
  const v1x=ax-bx,v1y=ay-by,v2x=cx-bx,v2y=cy-by;
  const n1=Math.hypot(v1x,v1y),n2=Math.hypot(v2x,v2y);
  if(!n1||!n2)return NaN;
  let cos=(v1x*v2x+v1y*v2y)/(n1*n2);
  return Math.acos(Math.max(-1,Math.min(1,cos)))*180/Math.PI;
}

function drawLabel(x,y,text,color){
  ctx.font="16px system-ui";ctx.textBaseline="top";
  const w=ctx.measureText(text).width+8;
  ctx.fillStyle="rgba(0,0,0,0.55)";ctx.fillRect(x-2,y-2,w,22);
  ctx.fillStyle=color;ctx.fillText(text,x,y);
}

async function init(){
  const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.10/wasm");
  landmarker=await PoseLandmarker.createFromOptions(vision,{
    baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.task"},
    runningMode:"VIDEO"
  });
  log("BlazePoseモデル読み込み完了","lime");
}
await init();

fileEl.addEventListener("change",async e=>{
  const f=e.target.files[0];if(!f)return;
  video.src=URL.createObjectURL(f);
  await new Promise(r=>video.onloadedmetadata=r);
  video.play();playing=true;
  requestAnimationFrame(loop);
});

async function loop(){
  if(!playing)return;
  const results=await landmarker.detectForVideo(video,performance.now());
  if(results.landmarks&&results.landmarks[0])drawPose(results.landmarks[0]);
  if(!video.paused&&!video.ended)requestAnimationFrame(loop);
}

function drawPose(kp){
  const w=canvas.width=canvas.clientWidth, h=canvas.height=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(video,0,0,w,h);
  const get=(i)=>({x:kp[i].x*w,y:kp[i].y*h,score:kp[i].visibility??1});
  const map={};
  for(let i=0;i<kp.length;i++)map[i]=get(i);

  // インデックス定義
  const L={K:26,A:28,T:32,S:12,E:14,W:16,H:24}; // 左
  const R={K:25,A:27,T:31,S:11,E:13,W:15,H:23}; // 右

  const vals={lknee:NaN,rknee:NaN,lelbow:NaN,relbow:NaN,lhip:NaN,rhip:NaN,lankle:NaN,rankle:NaN};

  // 各角度
  vals.lknee=angleDeg(map[L.H].x,map[L.H].y,map[L.K].x,map[L.K].y,map[L.A].x,map[L.A].y);
  vals.rknee=angleDeg(map[R.H].x,map[R.H].y,map[R.K].x,map[R.K].y,map[R.A].x,map[R.A].y);
  vals.lelbow=angleDeg(map[L.S].x,map[L.S].y,map[L.E].x,map[L.E].y,map[L.W].x,map[L.W].y);
  vals.relbow=angleDeg(map[R.S].x,map[R.S].y,map[R.E].x,map[R.E].y,map[R.W].x,map[R.W].y);
  vals.lhip=angleDeg(map[L.S].x,map[L.S].y,map[L.H].x,map[L.H].y,map[L.K].x,map[L.K].y);
  vals.rhip=angleDeg(map[R.S].x,map[R.S].y,map[R.H].x,map[R.H].y,map[R.K].x,map[R.K].y);
  vals.lankle=angleDeg(map[L.K].x,map[L.K].y,map[L.A].x,map[L.A].y,map[L.T].x,map[L.T].y);
  vals.rankle=angleDeg(map[R.K].x,map[R.K].y,map[R.A].x,map[R.A].y,map[R.T].x,map[R.T].y);

  const colors={knee:"#32de84",elbow:"#00bfff",hip:"#ba55d3",ankle:"#ffa500"};
  ctx.lineWidth=3;ctx.strokeStyle="#32de84";
  if(showAngles.checked){
    if(isFinite(vals.lankle))drawLabel(map[L.A].x+10,map[L.A].y+10,`L Ankle ${vals.lankle.toFixed(1)}°`,colors.ankle);
    if(isFinite(vals.rankle))drawLabel(map[R.A].x+10,map[R.A].y+10,`R Ankle ${vals.rankle.toFixed(1)}°`,colors.ankle);
    if(isFinite(vals.lknee))drawLabel(map[L.K].x+10,map[L.K].y+10,`L Knee ${vals.lknee.toFixed(1)}°`,colors.knee);
    if(isFinite(vals.rknee))drawLabel(map[R.K].x+10,map[R.K].y+10,`R Knee ${vals.rknee.toFixed(1)}°`,colors.knee);
    if(isFinite(vals.lelbow))drawLabel(map[L.E].x+10,map[L.E].y+10,`L Elbow ${vals.lelbow.toFixed(1)}°`,colors.elbow);
    if(isFinite(vals.relbow))drawLabel(map[R.E].x+10,map[R.E].y+10,`R Elbow ${vals.relbow.toFixed(1)}°`,colors.elbow);
    if(isFinite(vals.lhip))drawLabel(map[L.H].x+10,map[L.H].y+10,`L Hip ${vals.lhip.toFixed(1)}°`,colors.hip);
    if(isFinite(vals.rhip))drawLabel(map[R.H].x+10,map[R.H].y+10,`R Hip ${vals.rhip.toFixed(1)}°`,colors.hip);
  }

  angEl.innerHTML=`膝 L:${vals.lknee?.toFixed(1)??"-"} R:${vals.rknee?.toFixed(1)??"-"}　肘 L:${vals.lelbow?.toFixed(1)??"-"} R:${vals.relbow?.toFixed(1)??"-"}<br>
  股関節 L:${vals.lhip?.toFixed(1)??"-"} R:${vals.rhip?.toFixed(1)??"-"}　足首(つま先) L:${vals.lankle?.toFixed(1)??"-"} R:${vals.rankle?.toFixed(1)??"-"}`;
}
</script>
</body>
</html>
