<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>スプリント骨格コーチ（角度拡張版）</title>
  <style>
    :root { --w: 720px; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:#0c0f14; color:#e9eef6; }
    header { text-align:center; padding:10px 12px; }
    .wrap { max-width: var(--w); margin: 0 auto; padding: 8px 12px 24px; }
    #stage { position:relative; width:100%; aspect-ratio:9/16; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:0; } 
    #canvas { position:absolute; inset:0; width:100%; height:100%; }
    .ctrls, .kpis { display:grid; gap:10px; margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .btn, .sel, .chklabel, input[type=range] {
      border-radius:10px; border:1px solid #2a3442; background:#131a22; color:#e9eef6;
      padding:10px 12px; font-size:14px;
    }
    .btn { cursor:pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .panel { background:#0f141b; border:1px solid #223042; border-radius:10px; padding:10px; }
    #log { font-size:12px; background:#0b1220; border:1px solid #203047; padding:8px; border-radius:8px; max-height:170px; overflow:auto; }
    .timebar { display:flex; align-items:center; gap:10px; }
    .timebar input[type=range]{ flex:1 1 auto; height: 30px; }
    .time { width: 95px; text-align:center; }
    @media (max-width:760px){ :root { --w: 94vw; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
  <header><h1>スプリント骨格コーチ（角度拡張版）</h1></header>
  <div class="wrap">
    <div class="row">
      <input id="file" class="btn" type="file" accept="video/*">
      <select id="selModel" class="sel">
        <option value="SINGLEPOSE_LIGHTNING">Lightning（高速）</option>
        <option value="SINGLEPOSE_THUNDER">Thunder（高精度）</option>
      </select>
      <label class="chklabel"><input type="checkbox" id="showAngles" checked> 角度ラベル</label>
    </div>

    <div id="stage">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="ctrls panel">
      <div class="row">
        <button id="btnPlay" class="btn">▶ 再生</button>
        <button id="btnPause" class="btn">⏸ 一時停止</button>
        <button id="btnBack1f" class="btn">◀ 1f</button>
        <button id="btnFwd1f" class="btn">1f ▶</button>
        <button id="btnBack100ms" class="btn">◀ 0.1s</button>
        <button id="btnFwd100ms" class="btn">0.1s ▶</button>
      </div>
      <div class="row">
        <select id="selRate" class="sel">
          <option value="0.25">×0.25</option>
          <option value="0.5">×0.5</option>
          <option value="1" selected>×1.0</option>
          <option value="1.5">×1.5</option>
          <option value="2">×2.0</option>
        </select>
        <label class="chklabel"><input type="checkbox" id="loop"> ループ</label>
      </div>
      <div class="timebar">
        <span class="time mono" id="cur">00:00.00</span>
        <input type="range" id="seek" min="0" max="1000" value="0" step="1">
        <span class="time mono" id="dur">00:00.00</span>
      </div>
    </div>

    <div class="kpis">
      <div class="panel mono" id="angles">
        膝: L<span id="lknee">–</span>° / R<span id="rknee">–</span>°<br>
        肘: L<span id="lelbow">–</span>° / R<span id="relbow">–</span>°<br>
        股関節: L<span id="lhip">–</span>° / R<span id="rhip">–</span>°<br>
        足首: L<span id="lankle">–</span>° / R<span id="rankle">–</span>°
      </div>
      <div class="panel mono"><div id="log"></div></div>
    </div>
  </div>

  <script>
    const fileEl = document.getElementById('file');
    const selModel = document.getElementById('selModel');
    const showAngles = document.getElementById('showAngles');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const logEl = document.getElementById('log');
    const cur = document.getElementById('cur');
    const dur = document.getElementById('dur');
    const seek = document.getElementById('seek');
    const btnPlay = document.getElementById('btnPlay');
    const btnPause = document.getElementById('btnPause');
    const btnBack1f = document.getElementById('btnBack1f');
    const btnFwd1f = document.getElementById('btnFwd1f');
    const btnBack100ms = document.getElementById('btnBack100ms');
    const btnFwd100ms = document.getElementById('btnFwd100ms');
    const selRate = document.getElementById('selRate');
    const chkLoop = document.getElementById('loop');

    const angleEls = {
      lknee: document.getElementById('lknee'),
      rknee: document.getElementById('rknee'),
      lelbow: document.getElementById('lelbow'),
      relbow: document.getElementById('relbow'),
      lhip: document.getElementById('lhip'),
      rhip: document.getElementById('rhip'),
      lankle: document.getElementById('lankle'),
      rankle: document.getElementById('rankle'),
    };

    let detector = null, running = false, rafId = null, lastModelType = null;
    let vidW = 0, vidH = 0, drawScale = 1, offX = 0, offY = 0;

    const log = (m, c) => {
      const p = document.createElement('div');
      if (c) p.style.color = c;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
      logEl.prepend(p);
      console.log(m);
    };

    const fmt = s => (!isFinite(s)?'00:00.00':`${String(Math.floor(s/60)).padStart(2,'0')}:${(s%60).toFixed(2).padStart(5,'0')}`);

    function setStageAspect(w,h){ document.getElementById('stage').style.aspectRatio=`${w}/${h}`; }
    function resizeCanvasToStage(){
      const r = canvas.getBoundingClientRect();
      canvas.width = Math.max(1, Math.round(r.width));
      canvas.height = Math.max(1, Math.round(r.height));
      const s = Math.min(canvas.width/vidW, canvas.height/vidH);
      drawScale = s; offX = (canvas.width - vidW*s)/2; offY = (canvas.height - vidH*s)/2;
    }
    function angleDeg(ax,ay,bx,by,cx,cy){
      const v1x=ax-bx,v1y=ay-by,v2x=cx-bx,v2y=cy-by;
      const n1=Math.hypot(v1x,v1y),n2=Math.hypot(v2x,v2y);
      if(!n1||!n2)return NaN;
      let cos=(v1x*v2x+v1y*v2y)/(n1*n2);
      return Math.acos(Math.max(-1,Math.min(1,cos)))*180/Math.PI;
    }
    function drawLabel(x,y,text,color){
      ctx.font='16px system-ui'; ctx.textBaseline='top';
      const w=ctx.measureText(text).width+8;
      ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(x-2,y-2,w,22);
      ctx.fillStyle=color; ctx.fillText(text,x,y);
    }

    function drawPose(kp){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,offX,offY,vidW*drawScale,vidH*drawScale);

      const map={}; kp.forEach((p,i)=>{ map[i]={x:offX+p.x*drawScale,y:offY+p.y*drawScale,score:p.score}; });
      const draw=(i,j)=>{const a=map[i],b=map[j];if(!a||!b||a.score<.4||b.score<.4)return;ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.lineWidth=3;ctx.strokeStyle='#32de84';ctx.stroke();};
      const E={'5,7':1,'7,9':1,'6,8':1,'8,10':1,'5,6':1,'5,11':1,'6,12':1,'11,12':1,'11,13':1,'13,15':1,'12,14':1,'14,16':1};
      Object.keys(E).forEach(e=>draw(...e.split(',').map(Number)));
      Object.values(map).forEach(p=>{if(p.score<.4)return;ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle='#ffae00';ctx.fill();});

      // 各角度
      const colors={knee:'#32de84',elbow:'#00bfff',hip:'#ba55d3',ankle:'#ffa500'};
      const vals={lknee:NaN,rknee:NaN,lelbow:NaN,relbow:NaN,lhip:NaN,rhip:NaN,lankle:NaN,rankle:NaN};

      const L={S:kp[5],E:kp[7],W:kp[9],H:kp[11],K:kp[13],A:kp[15],T:kp[17]};
      const R={S:kp[6],E:kp[8],W:kp[10],H:kp[12],K:kp[14],A:kp[16],T:kp[18]};

      if(L.H&&L.K&&L.A) vals.lknee=angleDeg(L.H.x,L.H.y,L.K.x,L.K.y,L.A.x,L.A.y);
      if(R.H&&R.K&&R.A) vals.rknee=angleDeg(R.H.x,R.H.y,R.K.x,R.K.y,R.A.x,R.A.y);
// --- 足首角度（13-15-11 / 14-16-12）に変更 ---
if (L.K && L.A && L.H)
  vals.lankle = angleDeg(L.K.x, L.K.y, L.A.x, L.A.y, L.H.x, L.H.y);
if (R.K && R.A && R.H)
  vals.rankle = angleDeg(R.K.x, R.K.y, R.A.x, R.A.y, R.H.x, R.H.y);
      if(L.S&&L.H&&L.K) vals.lhip=angleDeg(L.S.x,L.S.y,L.H.x,L.H.y,L.K.x,L.K.y);
      if(R.S&&R.H&&R.K) vals.rhip=angleDeg(R.S.x,R.S.y,R.H.x,R.H.y,R.K.x,R.K.y);
      if(L.K&&L.A&&L.T) vals.lankle=angleDeg(L.K.x,L.K.y,L.A.x,L.A.y,L.T.x,L.T.y);
      if(R.K&&R.A&&R.T) vals.rankle=angleDeg(R.K.x,R.K.y,R.A.x,R.A.y,R.T.x,R.T.y);

      if(showAngles.checked){
        if(isFinite(vals.lknee)) drawLabel(map[13].x+10,map[13].y+10,`L Knee ${vals.lknee.toFixed(1)}°`,colors.knee);
        if(isFinite(vals.rknee)) drawLabel(map[14].x+10,map[14].y+10,`R Knee ${vals.rknee.toFixed(1)}°`,colors.knee);
        if(isFinite(vals.lelbow)) drawLabel(map[7].x+10,map[7].y+10,`L Elbow ${vals.lelbow.toFixed(1)}°`,colors.elbow);
        if(isFinite(vals.relbow)) drawLabel(map[8].x+10,map[8].y+10,`R Elbow ${vals.relbow.toFixed(1)}°`,colors.elbow);
        if(isFinite(vals.lhip)) drawLabel(map[11].x+10,map[11].y+10,`L Hip ${vals.lhip.toFixed(1)}°`,colors.hip);
        if(isFinite(vals.rhip)) drawLabel(map[12].x+10,map[12].y+10,`R Hip ${vals.rhip.toFixed(1)}°`,colors.hip);
        if(isFinite(vals.lankle)) drawLabel(map[15].x+10,map[15].y+10,`L Ankle ${vals.lankle.toFixed(1)}°`,colors.ankle);
        if(isFinite(vals.rankle)) drawLabel(map[16].x+10,map[16].y+10,`R Ankle ${vals.rankle.toFixed(1)}°`,colors.ankle);
      }

      for(const k in vals){ angleEls[k].textContent=isFinite(vals[k])?vals[k].toFixed(1):'–'; }
    }

    async function ensureDetector(){
      const type=selModel.value;
      if(detector&&lastModelType===type)return;
      if(detector)await detector.dispose();
      detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:poseDetection.movenet.modelType[type]});
      lastModelType=type; log(`MoveNetロード: ${type}`,'lime');
    }

    async function loop(){
      if(!running)return;
      rafId=requestAnimationFrame(loop);
      if(video.paused||video.ended||video.readyState<2)return;
      try{const poses=await detector.estimatePoses(video);if(poses&&poses[0])drawPose(poses[0].keypoints);}catch(e){log(`推論エラー: ${e.message}`,'tomato');}
      seek.value=Math.floor((video.currentTime/video.duration)*1000)||0;
      cur.textContent=fmt(video.currentTime);
    }

    fileEl.addEventListener('change',async e=>{
      const f=e.target.files&&e.target.files[0];if(!f)return;
      video.src=URL.createObjectURL(f);await new Promise(res=>video.onloadedmetadata=res);
      vidW=video.videoWidth||720;vidH=video.videoHeight||1280;
      setStageAspect(vidW,vidH);resizeCanvasToStage();
      dur.textContent=fmt(video.duration);cur.textContent=fmt(0);seek.value=0;
      video.loop=chkLoop.checked;video.playbackRate=parseFloat(selRate.value);
      log(`動画読込: ${f.name} (${vidW}×${vidH})`,'#9ae6b4');
      await ensureDetector();running=false;drawPose([]);
    });

    window.addEventListener('resize',resizeCanvasToStage);
    btnPlay.addEventListener('click',()=>{if(!video.src)return;video.playbackRate=parseFloat(selRate.value);video.loop=chkLoop.checked;video.play().then(()=>{if(!running){running=true;cancelAnimationFrame(rafId);loop();}});});
    btnPause.addEventListener('click',()=>{video.pause();running=false;cancelAnimationFrame(rafId);});
    const FRAME=1/30;
    function seekTo(t){video.pause();running=false;video.currentTime=Math.max(0,Math.min(video.duration,t));cur.textContent=fmt(video.currentTime);seek.value=Math.floor((video.currentTime/video.duration)*1000)||0;}
    btnBack1f.addEventListener('click',()=>seekTo(video.currentTime-FRAME));
    btnFwd1f.addEventListener('click',()=>seekTo(video.currentTime+FRAME));
    btnBack100ms.addEventListener('click',()=>seekTo(video.currentTime-0.1));
    btnFwd100ms.addEventListener('click',()=>seekTo(video.currentTime+0.1));
    selRate.addEventListener('change',()=>{video.playbackRate=parseFloat(selRate.value);});
    chkLoop.addEventListener('change',()=>{video.loop=chkLoop.checked;});
    seek.addEventListener('input',()=>{if(!video.src||!isFinite(video.duration))return;seekTo((seek.value/1000)*video.duration);});
    selModel.addEventListener('change',async()=>{if(!video.src&&!video.currentSrc)return;await ensureDetector();});
    log('動画を選択 → 解析開始（膝・肘・股関節・足首を色分け表示）','#a5b4fc');
  </script>
</body>
</html>
